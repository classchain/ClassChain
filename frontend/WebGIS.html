<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>نقشه پروژه‌های کلاس‌چین</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Vazirmatn', Tahoma, sans-serif; height: 100vh; overflow: hidden; background: #0f172a; color: #f1f5f9; }
        .container { display: flex; height: 100vh; }
        
        .info-panel {
            width: 380px;
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            color: white;
            display: flex;
            flex-direction: column;
            box-shadow: -4px 0 20px rgba(0,0,0,0.5);
            z-index: 500;
            border-left: 3px solid #10b981;
        }
        .panel-header {
            background: rgba(16,185,129,0.15);
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #10b981;
        }
        .panel-header h1 { font-size: 1.5em; color: #34d399; }
        .panel-content { flex: 1; padding: 20px; overflow-y: auto; }
        
        .province-info, .project-info {
            background: rgba(30,41,59,0.6);
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 15px;
            border-right: 5px solid #10b981;
            backdrop-filter: blur(8px);
        }
        .province-info h3, .project-info h3 {
            color: #34d399;
            margin-bottom: 12px;
            font-size: 1.4em;
            border-bottom: 1px dashed rgba(52,211,153,0.3);
            padding-bottom: 8px;
        }
        .info-row {
            margin: 10px 0;
            font-size: 0.98em;
            display: flex;
            justify-content: space-between;
        }
        .info-label { color: #94a3b8; font-weight: bold; }
        .info-value { color: #e2e8f0; text-align: left; flex: 1; margin-right: 10px; }

        .no-selection {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }
        .no-selection h3 { margin: 20px 0; color: #94a3b8; }

        #map { flex: 1; height: 100vh; }

        /* آیکون پروژه — زیبا، پالسی و مقیاس‌پذیر */
        .project-marker {
            background: #10b981;
            border: 3px solid #fff;
            border-radius: 50%;
            width: 32px !important;
            height: 32px !important;
            box-shadow: 0 0 20px rgba(16,185,129,0.8);
            animation: pulse 2s infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 14px;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(16,185,129,0.7); }
            70% { box-shadow: 0 0 0 15px rgba(16,185,129,0); }
            100% { box-shadow: 0 0 0 0 rgba(16,185,129,0); }
        }

        .back-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
        }
        .back-btn:hover { background: #059669; }
    </style>
</head>
<body>

<div class="container">
    <div class="info-panel">
        <div class="panel-header">
            <h1>نقشه کلاس‌چین</h1>
            <p>استان‌ها: کلیک کنید • پروژه‌ها: نقاط سبز</p>
        </div>
        <div class="panel-content" id="infoContent">
            <div class="no-selection">
                <h3>یک استان یا پروژه را انتخاب کنید</h3>
                <p>اطلاعات کامل در اینجا نمایش داده می‌شود</p>
            </div>
        </div>
    </div>
    <div id="map"></div>
</div>

<a href="index.html" class="back-btn">بازگشت به خانه</a>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// === نقشه اصلی ===
const map = L.map('map').setView([32.4279, 53.6880], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// متغیرهای سراسری
let selectedLayer = null;
let selectedCountyLayer = null;
let countiesLayer = null;
let projectsLayer = L.layerGroup().addTo(map);

// === لایه استان‌ها ===
let geo;
fetch('ir-new.json')
    .then(r => r.json())
    .then(data => {
        geo = L.geoJSON(data, {
            style: feature => {
                const area = feature.properties.area || 0;
                const intensity = Math.min(area / 150000, 1);
                return {
                    fillColor: `rgb(${Math.floor(50 + 150 * intensity)}, ${Math.floor(200 - 100 * intensity)}, 100)`,
                    weight: 2,
                    opacity: 1,
                    color: 'white',
                    fillOpacity: 0.7
                };
            },
            onEachFeature: (feature, layer) => {
                layer.on('click', () => {
                    if (selectedLayer) geo.resetStyle(selectedLayer);
                    layer.setStyle({ weight: 5, color: '#10b981' });
                    selectedLayer = layer;
                    showProvinceCounties(feature.properties.pname || feature.properties.Name);
                });
            }
        }).addTo(map);
    });

// === لایه شهرستان‌ها ===
function showProvinceCounties(provinceName) {
    if (countiesLayer) map.removeLayer(countiesLayer);
    countiesLayer = L.geoJSON(null, {
        style: { color: '#6366f1', weight: 1, fillOpacity: 0.5 },
        onEachFeature: (f, l) => {
            const label = L.divIcon({
                className: 'county-label',
                html: f.properties.Name || f.properties.cname || '',
                iconSize: [100, 40]
            });
            L.marker(l.getBounds().getCenter(), { icon: label }).addTo(countiesLayer);
        }
    });

    fetch('counties.json')
        .then(r => r.json())
        .then(data => {
            let count = 0;
            data.features.forEach(f => {
                if ((f.properties.pname || f.properties.Name) === provinceName) {
                    countiesLayer.addData(f);
                    count++;
                }
            });
            countiesLayer.addTo(map);
            document.getElementById('infoContent').innerHTML = `
                <div class="province-info">
                    <h3>${provinceName}</h3>
                    <div class="info-row"><span class="info-label">تعداد شهرستان:</span><span class="info-value">${count} شهرستان</span></div>
                </div>
            `;
        });
}

// === لایه پروژه‌ها (Projects.json) ===
async function loadProjects() {
    try {
        const response = await fetch('Projects.json');
        const data = await response.json();

        data.features.forEach(feature => {
            const p = feature.attributes;
            const x = feature.geometry.x;
            const y = feature.geometry.y;
            if (!x || !y) return;

            const marker = L.marker([y, x], {
                icon: L.divIcon({
                    className: 'project-marker',
                    html: 'School',
                    iconSize: [32, 32]
                })
            });

            marker.on('click', () => {
                showProjectInfo(p);
                map.flyTo([y, x], 15, { duration: 1.5 });
            });

            // فقط در زوم ۷ به بالا نمایش بده
            map.on('zoomend', () => {
                if (map.getZoom() >= 7) {
                    marker.addTo(projectsLayer);
                } else {
                    projectsLayer.removeLayer(marker);
                }
            });

            if (map.getZoom() >= 7) marker.addTo(projectsLayer);
        });
    } catch (err) {
        console.error("خطا در بارگذاری پروژه‌ها:", err);
    }
}

function showProjectInfo(p) {
    document.getElementById('infoContent').innerHTML = `
        <div class="project-info">
            <h3>${p["نام پروژه"] || "نامشخص"}</h3>
            <div class="info-row"><span class="info-label">استان:</span><span class="info-value">${p["استان"] || "-"}</span></div>
            <div class="info-row"><span class="info-label">منطقه:</span><span class="info-value">${p["منطقه"] || "-"}</span></div>
            <div class="info-row"><span class="info-label">تعداد کلاس:</span><span class="info-value">${p["تعداد کلاس"] || "-"}</span></div>
            <div class="info-row"><span class="info-label">زیربنا:</span><span class="info-value">${p["زیربنا"] ? p["زیربنا"] + " مترمربع" : "-"}</span></div>
            <div class="info-row"><span class="info-label">وضعیت:</span><span class="info-value">${p["وضعیت راهبری پروژه"] || "-"}</span></div>
            ${p["آدرس کیف پول"] 
                ? `<a href="Scale-CLC.html?project=${p["کد پروژه"]}" style="display:block;margin-top:20px;padding:14px;background:#10b981;color:white;border-radius:50px;text-align:center;text-decoration:none;font-weight:bold;">
                    حمایت از این پروژه
                   </a>`
                : '<p style="color:#f87171;margin-top:20px;">کیف پول هنوز ایجاد نشده</p>'
            }
        </div>
    `;
}

// بارگذاری همه لایه‌ها
loadProjects();

// بازگشت به ایران
function zoomToIran() {
    map.flyTo([32.4279, 53.6880], 6, { duration: 1.5 });
    if (selectedLayer) geo.resetStyle(selectedLayer);
    selectedLayer = null;
    if (countiesLayer) map.removeLayer(countiesLayer);
    document.getElementById('infoContent').innerHTML = `
        <div class="no-selection">
            <h3>یک استان یا پروژه را انتخاب کنید</h3>
        </div>
    `;
}
</script>
</body>
</html>
