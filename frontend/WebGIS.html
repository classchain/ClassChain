<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>WebGIS ایران - بر اساس سرانه جمعیت + پروژه‌های آموزشی</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
	<script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; height: 100vh; overflow: hidden; }
        .container { display: flex; height: 100vh; }

		.info-panel {
    		width: 350px;
    		background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
    		color: white;
    		display: flex;
    		flex-direction: column;
    		box-shadow: -2px 0 10px rgba(0,0,0,0.3);
    		z-index: 500;
    		position: relative; /* ← اضافه شد */
			height: 100%; /* مطمئن شو که این وجود داره */
		}
        .panel-header {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #3498db;
        }
        .panel-header h1 { font-size: 1.4em; margin-bottom: 5px; color: #ecf0f1; }
        .panel-header p { opacity: 0.9; font-size: 0.9em; color: #bdc3c7; }
		
        .panel-content { flex: 1; padding: 20px; overflow-y: auto; }

        /* استایل جدید برای بخش‌های آبشاری (Accordion) */
        .accordion-section {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            margin-bottom: 15px;
            border-right: 4px solid #3498db;
            overflow: hidden;
        }
        .accordion-title {
            background: rgba(255,255,255,0.15);
            padding: 12px 15px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: bold;
            color: #ecf0f1;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .accordion-title::after {
            content: "▼";
            font-size: 0.9em;
            transition: transform 0.3s ease;
        }
        .accordion-title.collapsed::after {
            transform: rotate(-90deg);
        }
        .accordion-content {
            padding: 15px;
            display: block;
        }
        .accordion-content.collapsed {
            display: none;
        }


        .province-info, .project-info {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-right: 4px solid #3498db;
        }
		
        .province-info h3, .project-info h3 {
            color: #ecf0f1;
            margin-bottom: 10px;
            font-size: 1.3em;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 8px;
        }
        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 0.95em;
        }
        .info-label { font-weight: bold; color: #bdc3c7; }
        .info-value { color: #ecf0f1; text-align: left; }

        /* اضافه شده برای حل مشکل بیرون‌زدگی آدرس قرارداد */
        .contract-address {
            word-break: break-all;
            font-size: 0.85em;
            line-height: 1.4;
        }

        .no-selection {
            text-align: center;
            padding: 40px 20px;
            color: #bdc3c7;
            opacity: 0.7;
        }
        .no-selection .icon { font-size: 3.5em; margin-bottom: 15px; opacity: 0.5; }

        #map { flex: 1; height: 100vh; }

        .panel-content::-webkit-scrollbar { width: 6px; }
        .panel-content::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 3px; }
        .panel-content::-webkit-scrollbar-thumb { background: #3498db; border-radius: 3px; }
		.panel-content {
    		flex: 1 1 Auto;
    		padding: 20px /* 20px 140px 20px;  /* پایین رو بیشتر کردیم تا فضای کافی برای دکمه + حاشیه باشه */
    		overflow-y: auto;
			padding: 20px;
		}
		.fixed-contribute-button {
    		position: sticky;          /* نسبت به info-panel */
    		bottom: 1px;
    		left: 15px;
    		right: 15px;
    		text-align: center;
    		background: rgba(39, 174, 96, 0.98);
    		padding: 18px 15px;
    		border-radius: 12px;
    		box-shadow: 0 8px 30px rgba(0,0,0,0.5);
    		backdrop-filter: blur(12px);
    		z-index: 20;
    		border: 1px solid rgba(255,255,255,0.15);
    		display: none;               /* ← اضافه شد */
		}
		
		.fixed-contribute-button button {
    		padding: 14px 28px;
    		background: #27ae60;
    		color: white;
    		border: none;
    		border-radius: 10px;
    		font-size: 1.15em;
    		font-weight: bold;
    		cursor: pointer;
    		width: 100%;
    		box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    		transition: transform 0.2s ease;
		}
		
		.fixed-contribute-button button:hover {
    		transform: translateY(-2px);
		}

		.fixed-contribute-button p {
    		margin-top: 10px;
    		font-size: 0.9em;
    		opacity: 0.9;
		}
		
         .report-link {
            display: block;
            padding: 8px 0;
            color: #3498db;
            text-decoration: underline;
            font-size: 0.95em;
        }
        .report-link:hover {
            color: #5ab9ea;
        }

       .custom-basemap-selector, .home-button {
            position: absolute;
            z-index: 1000;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(12px);
            border-radius: 30px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
            border: 1px solid rgba(255,255,255,0.4);
            font-family: inherit;
            user-select: none;
            transition: all 0.3s ease;
        }
        .custom-basemap-selector {
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
        }
        #basemapSelect {
            padding: 12px 24px;
            font-size: 15px;
            border: none;
            background: transparent;
            color: #2c3e50;
            cursor: pointer;
            outline: none;
            min-width: 240px;
            text-align: font-weight: 500;
        }
        .home-button {
            top: 86px;
            left: 10px;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .home-button:hover { background: #3498db; transform: scale(1.1); }
        .home-button:hover svg { fill: white; }
    </style>
</head>
<body>
	<div class="container">
    	<div class="info-panel">
        	<div class="panel-header">
            	<h1>WebGIS ایران</h1>
            	<p>رنگ بر اساس سرانه جمعیت + پروژه‌های آموزشی</p>
        	</div>
        	<div class="panel-content" id="infoPanel">
				<div class="fixed-contribute-button" id="fixedContributeBtn">
    				<button onclick="contributeToProject(currentContractAddress)">
			    	    مشارکت در ساخت
    				</button>
    				<p>(اتصال به MetaMask و ارسال USDT در شبکه Polygon)</p>
				</div>
            	<div class="no-selection">
            		<div class="icon">Map</div>
            		<h3>یک مورد را انتخاب کنید</h3>
            		<p>روی استان، شهرستان یا پروژه کلیک کنید</p>
           		</div>
        	</div>
    	</div>
    	<div id="map"></div>
	</div>

	<div class="custom-basemap-selector">
    	<select id="basemapSelect" onchange="changeBasemap(this.value)">
        	<option value="carto">رنگارنگ و سریع (پیش‌فرض)</option>
        	<option value="persiangis">نقشه فارسی (PersianGIS)</option>
        	<option value="satellite">ماهواره‌ای (Esri)</option>
        	<option value="light">خاکستری روشن</option>
        	<option value="osm">استاندارد (OSM)</option>
    	</select>
	</div>

	<div class="home-button" onclick="zoomToIran()" title="بازگشت به ایران">
    	<svg viewBox="0 0 24 24" width="22" height="22" fill="currentColor">
        	<path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
    	</svg>
	</div>
	
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

<script>
let currentContractAddress = null;
const map = L.map('map', {
        renderer: L.canvas()
    }).setView([32.4279, 53.6880], 5);
    
    let selectedLayer = null;
    let selectedCountyLayer = null;
    let selectedProjectMarker = null;
    let geo, countiesLayer = null, projectsLayer = null;

    // تابع نمایش اطلاعات در پنل
    function showInPanel(content) {
        document.getElementById('infoPanel').innerHTML = content;
    }
	
// توابع کلیک روی عنوان برای باز/بسته کردن بخش
function toggleAccordion(element) {
    element.classList.toggle('collapsed');
    const content = element.nextElementSibling;
    content.classList.toggle('collapsed');
}
    // رنگ استان‌ها
    function getProvinceColor(capita, min, max) {
        if (capita === 0 || capita == null) return '#34495e';
        const ratio = max === min ? 0.5 : (capita - min) / (max - min);
        const r = Math.min(255, Math.round(52 + ratio * 200));
        const g = Math.min(255, Math.round(73 + ratio * 182));
        const b = Math.min(255, Math.round(94 + ratio * 161));
        return `rgb(${r},${g},${b})`;
    }

    function getCountyColor(capita, min, max) {
        if (capita === 0 || capita == null) return '#777777';
        const ratio = max === min ? 0.5 : (capita - min) / (max - min);
        const r = Math.round(139 + ratio * 113);
        const g = Math.round(0 + ratio * 228);
        const b = Math.round(0 + ratio * 236);
        return `rgb(${r},${g},${b})`;
    }
// >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
// آیکون‌های پروژه
    const normalIcon = L.divIcon({
        html: `<div style="background:#e74c3c; width:12px; height:12px; border-radius:50%; border:2px solid white; box-shadow:0 0 8px rgba(0,0,0,0.7);"></div>`,
        className: 'custom-div-icon',
        iconSize: [16, 16],
        iconAnchor: [8, 8]
    });
    
const selectedIcon = L.divIcon({
        html: `<div style="background:#f1c40f; width:20px; height:20px; border-radius:50%; border:4px solid white; box-shadow:0 0 12px rgba(241,196,15,0.8); animation:pulse 1.5s infinite;"></div>`,
        className: 'custom-div-icon',
        iconSize: [28, 28],
        iconAnchor: [14, 14]
    });
const projectIcon = L.divIcon({
        html: `<div style="background:#e74c3c; width:10px; height:10px; border-radius:50%; border:2px solid white; box-shadow:0 0 6px rgba(0,0,0,0.8);"></div>`,
        className: 'custom-project-marker',
        iconSize: [14, 14],
        iconAnchor: [7, 7]
    });

    const selectedProjectIcon = L.divIcon({
        html: `<div style="background:#f1c40f; width:18px; height:18px; border-radius:50%; border:3px solid white; box-shadow:0 0 12px #f1c40f;"></div>`,
        className: 'custom-project-marker',
        iconSize: [24, 24],
        iconAnchor: [12, 12]
    });

    // ایجاد خوشه مارکرها (این دقیقاً همان چیزی است که در وب‌جی‌آی‌اس‌های حرفه‌ای می‌بینی)
    const markersCluster = L.markerClusterGroup({
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true,
        maxClusterRadius: 60, // در زوم کم خوشه‌های بزرگ‌تر
        iconCreateFunction: function(cluster) {
            const count = cluster.getChildCount();
            let size = count < 10 ? 40 : count < 100 ? 50 : 60;
            return L.divIcon({
                html: `<div style="background:#e74c3c;color:white;font-weight:bold;border-radius:50%;width:${size}px;height:${size}px;line-height:${size}px;text-align:center;box-shadow:0 0 12px rgba(0,0,0,0.6);font-size:14px;">${count}</div>`,
                className: '',
                iconSize: [size, size]
            });
        }
    });

// اضافه کردن انیمیشن پالس
    const style = document.createElement('style');
    style.innerHTML = `
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(241,196,15,0.7); }
            70% { box-shadow: 0 0 0 10px rgba(241,196,15,0); }
            100% { box-shadow: 0 0 0 0 rgba(241,196,15,0); }
        }
    `;
    document.head.appendChild(style);
    
    // بارگذاری استان‌ها
    fetch('data/ir-new.json')
        .then(r => r.json())
        .then(data => {
            const features = data.features.map(f => ({
                type: "Feature",
                geometry: { type: "Polygon", coordinates: f.geometry.rings },
                properties: f.attributes
            }));

            const capitas = features.map(f => f.properties.P_capita || 0).filter(c => c > 0);
            const minCapita = capitas.length ? Math.min(...capitas) : 1;
            const maxCapita = capitas.length ? Math.max(...capitas) : 1;

            geo = L.geoJSON(features, {
                style: feature => ({
                    color: "#2c3e50", weight: 2,
                    fillColor: getProvinceColor(feature.properties.P_capita || 0, minCapita, maxCapita),
                    fillOpacity: 0.75
                }),
                onEachFeature: (feature, layer) => {
                    const p = feature.properties;

                    layer.on('click', e => {
                        L.DomEvent.stopPropagation(e);
                        if (selectedLayer) geo.resetStyle(selectedLayer);
                        if (selectedCountyLayer) countiesLayer?.resetStyle(selectedCountyLayer);
                        if (selectedProjectMarker) selectedProjectMarker.setIcon(normalIcon);

                        layer.setStyle({ weight: 6, color: "#e74c3c", fillOpacity: 0.9 });
                        selectedLayer = layer;
                        layer.bringToFront();
                        map.fitBounds(layer.getBounds(), { padding: [40, 40], animate: true, duration: 1.3 });

                        showInPanel(`
                            <div class="province-info">
                                <h3>استان ${p.Name || 'نامشخص'}</h3>
                                ${p.pcenter ? `<div class="info-item"><span class="info-label">مرکز استان:</span><span class="info-value">${p.pcenter}</span></div>` : ''}
                                ${p.population > 0 ? `<div class="info-item"><span class="info-label">جمعیت (۱۳۹۵):</span><span class="info-value">${Number(p.population).toLocaleString('fa-IR')}</span></div>` : ''}
                                ${p.P_capita ? `<div class="info-item"><span class="info-label">سرانه استانی:</span><span class="info-value">${Number(p.P_capita).toFixed(2)}</span></div>` : ''}
                                <div class="info-item"><span class="info-label">شهرستان‌ها:</span><span class="info-value">در حال بارگذاری...</span></div>
                            </div>
                        `);

                        showCountiesOfProvince(p.Name);
                    });

                    layer.on('mouseover', () => { if (selectedLayer !== layer) layer.setStyle({ weight: 5 }); });
                    layer.on('mouseout', () => { if (selectedLayer !== layer) geo.resetStyle(layer); });
                }
            }).addTo(map);
        });

    // نمایش شهرستان‌ها (همان کد قبلی بدون تغییر)
    function showCountiesOfProvince(provinceName) {
        if (!countiesLayer) {
            fetch('data/counties.json')
                .then(r => r.json())
                .then(raw => {
                    let features = raw.features?.[0]?.geometry?.rings 
                        ? raw.features.map(f => ({ type: "Feature", geometry: { type: "Polygon", coordinates: f.geometry.rings }, properties: f.attributes }))
                        : raw.features || raw;

                    const capitas = features.map(f => f.properties.C_capita || 0).filter(c => c > 0);
                    const minCapita = capitas.length ? Math.min(...capitas) : 1;
                    const maxCapita = capitas.length ? Math.max(...capitas) : 1;

                    countiesLayer = L.geoJSON(features, {
                        style: feature => {
                            const c = feature.properties.C_capita || 0;
                            return {
                                color: c === 0 ? "#555555" : "#2c3e50",
                                weight: c === 0 ? 2.5 : 1.5,
                                fillColor: getCountyColor(c, minCapita, maxCapita),
                                fillOpacity: c === 0 ? 0.9 : 0.75
                            };
                        },
                        onEachFeature: (feature, layer) => {
                            const c = feature.properties;

                            layer.on('click', e => {
                                L.DomEvent.stopPropagation(e);
                                if (selectedCountyLayer && selectedCountyLayer !== layer) countiesLayer.resetStyle(selectedCountyLayer);
                                if (selectedProjectMarker) selectedProjectMarker.setIcon(normalIcon);

                                //layer.setStyle({ weight: 6, color: "#c62828", fillOpacity: 0.9 });
                                layer.setStyle({ weight: 6, color: "#c62828", fill:false });
								if (selectedLayer) {
    								selectedLayer.setStyle({ fillOpacity: 0 });
								}
                                selectedCountyLayer = layer;
                                layer.bringToFront();
                                map.fitBounds(layer.getBounds(), { padding: [30, 30], animate: true, duration: 1 });

                                showInPanel(`
                                    <div class="province-info">
                                        <h3>${c.Name || c.name || 'نامشخص'}</h3>
                                        <div class="info-item"><span class="info-label">استان:</span><span class="info-value">${c.pname || c.Pname || provinceName}</span></div>
                                        ${c.ccenter_na ? `<div class="info-item"><span class="info-label">مرکز شهرستان:</span><span class="info-value">${c.ccenter_na}</span></div>` : ''}
                                        ${c.area ? `<div class="info-item"><span class="info-label">مساحت:</span><span class="info-value">${Number(c.area).toLocaleString('fa-IR')} هکتار</span></div>` : ''}
                                        ${c.C_capita !== undefined ? `<div class="info-item"><span class="info-label">سرانه شهرستانی:</span><span class="info-value">${c.C_capita === 0 ? 'صفر' : Number(c.C_capita).toFixed(2)}</span></div>` : ''}
                                    </div>
                                `);
                            });

                            if ((c.pname || c.Pname) === provinceName) layer.addTo(map);
                        }
                    });

                    showCountiesOfProvince(provinceName);
                });
            return;
        }

        let count = 0;
        countiesLayer.eachLayer(l => {
            const pname = l.feature.properties.pname || l.feature.properties.Pname;
            if (pname === provinceName) {
                l.addTo(map);
                countiesLayer.resetStyle(l);
                if (l === selectedCountyLayer) l.setStyle({ weight: 6, color: "#c62828" });
                count++;
            } else map.removeLayer(l);
        });

        const panel = document.querySelector('.info-item:last-child');
        if (panel && panel.querySelector('.info-label')?.textContent.includes('شهرستان')) {
            panel.innerHTML = `<span class="info-label">تعداد شهرستان:</span><span class="info-value">${count} شهرستان</span>`;
        }
    }

    // بارگذاری پروژه‌های آموزشی از Projects.json
fetch('data/Projects.json')
    .then(r => r.json())
    .then(data => {
        data.features.forEach(feature => {
            const a = feature.attributes;
            const x = a.x;
            const y = a.y;

            if (x && y && !isNaN(x) && !isNaN(y)) {
                const marker = L.marker([y, x], { icon: projectIcon });
                marker.properties = a;

                marker.on('click', function(e) {
                    if (selectedProjectMarker) {
                        selectedProjectMarker.setIcon(projectIcon);
                    }

                    this.setIcon(selectedProjectIcon);
                    selectedProjectMarker = this;

                    if (selectedLayer) {
                        selectedLayer.setStyle({ fillOpacity: 0 });
                    }

                    if (selectedCountyLayer) {
                        selectedCountyLayer.setStyle({ fillOpacity: 0 });
                    }

                    let financialInfo = '';

                    if (a.contractAddress && a.contractAddress !== null && a.contractAddress !== "") {
                        financialInfo = `


                        <div class="info-item" style="background:rgba(46,204,113,0.2); padding:12px; border-radius:8px; margin-top:15px;">
                            <span class="info-label">خزانه هوشمند پروژه:</span><br>
                            <span class="info-value contract-address">
                                <a href="https://polygonscan.com/address/${a.contractAddress}" target="_blank" style="color:#3498db; text-decoration:underline;">
                                    ${a.contractAddress}
                                </a>
                            </span>
                        </div>

                        <div class="info-item" style="margin-top:15px;">
                            <span class="info-label">برآورد هزینه ساخت:</span>
                            <span class="info-value">${a['targetAmount(USDT)'] ? Number(a['targetAmount(USDT)']).toLocaleString('fa-IR') + ' USDT' : 'نامشخص'}</span>
                        </div>

                        <div id="donorsList" style="margin-top:15px;">
                            <span class="info-label">در حال بارگذاری لیست کمک‌کنندگان...</span>
                        </div>
                        `;
                    } else {
                        financialInfo = '<div class="info-item" style="color:#e67e22; margin-top:15px;">خزانه هوشمند هنوز راه‌اندازی نشده</div>';
                    }

                    showInPanel(`
                        <div class="accordion-section">
                            <div class="accordion-title" onclick="toggleAccordion(this)">اطلاعات عمومی پروژه</div>
                            <div class="accordion-content">
                                <div class="info-item"><span class="info-label">نام پروژه:</span><span class="info-value">${a['نام پروژه'] || 'بدون نام'}</span></div>
                                <div class="info-item"><span class="info-label">کد پروژه:</span><span class="info-value">${a['ProjectID']}</span></div>
                                <div class="info-item"><span class="info-label">استان:</span><span class="info-value">${a['استان']}</span></div>
                                <div class="info-item"><span class="info-label">منطقه:</span><span class="info-value">${a['منطقه']}</span></div>
                                <div class="info-item"><span class="info-label">نوع پروژه:</span><span class="info-value">${a['نوع پروژه (نیاز)']}</span></div>
                                <div class="info-item"><span class="info-label">تعداد کلاس:</span><span class="info-value">${a['تعداد کلاس'] || '—'}</span></div>
                                <div class="info-item"><span class="info-label">زیربنا:</span><span class="info-value">${a['زیربنا'] ? Number(a['زیربنا']).toLocaleString('fa-IR') + ' م²' : '—'}</span></div>
                                <div class="info-item"><span class="info-label">وضعیت:</span><span class="info-value">${a['وضعیت راهبری پروژه'] || '—'}</span></div>
                                <div class="info-item"><span class="info-label">مسئول:</span><span class="info-value">${a['مسئول پروژه'] || '—'}</span></div>
                                <div class="info-item"><span class="info-label">تلفن:</span><span class="info-value">${a['شماره تلفن مسئول پروژه'] || '—'}</span></div>
                                ${a['آدرس پروژه'] ? `<div class="info-item"><span class="info-label">آدرس:</span><span class="info-value">${a['آدرس پروژه']}</span></div>` : ''}
                            </div>
                        </div>

                        <div class="accordion-section">
                            <div class="accordion-title" onclick="toggleAccordion(this)">اطلاعات مالی</div>
                            <div class="accordion-content">
                                ${financialInfo}
                            </div>
                        </div>

                        <div class="accordion-section">
                            <div class="accordion-title" onclick="toggleAccordion(this)">گزارشات پروژه</div>
                            <div class="accordion-content">
                                <a href="project-images.html?project=${a['ProjectID']}" class="report-link" target="_blank">تصاویر</a>
                                <a href="financial-docs.html?project=${a['ProjectID']}" class="report-link" target="_blank">مستندات مالی</a>
                            </div>
                        </div>

                        <div class="fixed-contribute-button" id="fixedContributeBtn" style="display: none;">
                            <button onclick="contributeToProject('${a.contractAddress || ''}')">
                                مشارکت در ساخت
                            </button>
                            <p>(اتصال به MetaMask و ارسال USDT در شبکه Polygon)</p>
                        </div>
                    `);

                    if (a.contractAddress && a.contractAddress !== null && a.contractAddress !== "") {
                        currentContractAddress = a.contractAddress;
                        loadDonors(a.contractAddress);
                        document.getElementById('fixedContributeBtn').style.display = 'block';
                    } else {
                        currentContractAddress = null;
                        document.getElementById('fixedContributeBtn').style.display = 'none';
                    }

                    map.setView([y, x], 14, { animate: true });
                });

                markersCluster.addLayer(marker);
            }
        });

        map.addLayer(markersCluster);
        console.log(`${data.features.length} پروژه با خوشه‌بندی بارگذاری شد`);
    })
    .catch(err => {
        console.error("خطا در بارگذاری پروژه‌ها:", err);
    });
	
async function loadDonors(contractAddress) {
    const apiKey = "DYB75BHRNWEGAGAEH73AWJUPQ8EDRKN7RB"; // از https://polygonscan.com/myapikey رایگان بگیر
	const clcTokenAddress = "0x39Af73d2736f6EC94778a38c0C7Ef800e58B13a7"; // توکن CLC تست
	const url = `https://api-amoy.polygonscan.com/api?module=account&action=tokentx&contractaddress=0x41e94eb019c0762f9bfcf9fb78e59bec0a32e187&address=${contractAddress}&sort=desc&apikey=${apiKey}`;
    try {
        const response = await fetch(url);
        const data = await response.json();

        if (data.status === "1" && data.result.length > 0) {
            let totalRaised = 0;
            let donorsHtml = '<h4 style="color:#ecf0f1; margin:15px 0 10px;">کمک‌کنندگان</h4>';

            const uniqueDonors = new Map(); // برای جمع زدن کمک‌های تکراری

            data.result.forEach(tx => {
                if (tx.to.toLowerCase() === contractAddress.toLowerCase()) {
                    const amount = parseInt(tx.value) / 1e6; // USDT 6 اعشار
                    totalRaised += amount;

                    const from = tx.from;
                    if (uniqueDonors.has(from)) {
                        uniqueDonors.set(from, uniqueDonors.get(from) + amount);
                    } else {
                        uniqueDonors.set(from, amount);
                    }
                }
            });

            // نمایش جمع کل
            document.querySelector('#donorsList').innerHTML = `
                <div class="info-item">
                    <span class="info-label">جمع کمک‌های دریافتی:</span>
                    <span class="info-value">${totalRaised.toFixed(2)} USDT</span>
                </div>
            ` + donorsHtml;

            // لیست کمک‌کنندگان
            uniqueDonors.forEach((amount, address) => {
                donorsHtml += `
                <div class="info-item" style="font-size:0.9em; background:rgba(255,255,255,0.05); margin:5px 0; padding:8px; border-radius:6px;">
                    <span class="info-value">
                        <a href="https://polygonscan.com/address/${address}" target="_blank" style="color:#3498db;">
                            ${address.substring(0,8)}...${address.substring(36)}
                        </a>
                    </span>
                    <span class="info-label">${amount.toFixed(2)} USDT</span>
                </div>
                `;
            });

            document.querySelector('#donorsList').innerHTML += donorsHtml;
        } else {
            document.querySelector('#donorsList').innerHTML = '<p style="opacity:0.7;">شما اولین مشارکت کننده این مدرسه باشید</p>';
        }
    } catch (err) {
        document.querySelector('#donorsList').innerHTML = '<p style="color:#e74c3c;">خطا در بارگذاری کمک‌ها</p>';
    }
}

    // بازگشت به ایران
function zoomToIran() {
        map.flyTo([32.4279, 53.6880], 5, { animate: true, duration: 1.5 });
        if (selectedLayer) { geo?.resetStyle(selectedLayer); selectedLayer = null; }
        if (selectedCountyLayer) { countiesLayer?.resetStyle(selectedCountyLayer); selectedCountyLayer = null; }
        if (selectedProjectMarker) { selectedProjectMarker.setIcon(projectIcon); selectedProjectMarker = null; }
        if (countiesLayer) map.removeLayer(countiesLayer);

        showInPanel(`
            <div class="no-selection">
                <div class="icon">Map</div>
                <h3>یک مورد را انتخاب کنید</h3>
                <p>روی استان، شهرستان یا پروژه کلیک کنید</p>
            </div>
        `);
		const fixedBtn = document.getElementById('fixedContributeBtn');
		if (fixedBtn) fixedBtn.style.display = 'none';
		currentContractAddress = null;
    }
    // لایه‌های پایه
    const basemapLayers = {
        carto: L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '© CartoDB' }),
        persiangis: L.tileLayer('https://map.persiangis.ir/tile/{z}/{x}/{y}.png', { attribution: '© PersianGIS' }),
        satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' }),
        light: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '© CartoDB' }),
        osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' })
    };

    let currentBasemap = basemapLayers.carto;
    currentBasemap.addTo(map);

    function changeBasemap(val) {
        map.removeLayer(currentBasemap);
        currentBasemap = basemapLayers[val];
        currentBasemap.addTo(map);
    }

async function contributeToProject(contractAddress) {
    if (!contractAddress) return;
	
    if (typeof window.ethereum === 'undefined') {
        alert('لطفاً افزونه MetaMask را نصب کنید یا از مرورگر سازگار با Web3 استفاده کنید.');
        window.open('https://metamask.io/download/', '_blank');
        return;
    }

    try {
        // درخواست اتصال کیف پول
        await window.ethereum.request({ method: 'eth_requestAccounts' });

        const web3 = new Web3(window.ethereum);
        const accounts = await web3.eth.getAccounts();
        const userAddress = accounts[0];

        // آدرس USDT در شبکه Polygon Mainnet
        const usdtAddress = '0xc2132D05D31c914a87C6611C10748AEb04B58e8F';
        const usdtDecimals = 6;

        // مقدار پیش‌فرض (مثلاً ۱۰ USDT) - کاربر می‌تواند بعداً تغییر دهد
        let amount = prompt('مقدار USDT برای مشارکت را وارد کنید (مثلاً 10):', '10');
        if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
            alert('مقدار معتبر وارد کنید.');
            return;
        }
        amount = parseFloat(amount);

        const value = web3.utils.toBN(amount * Math.pow(10, usdtDecimals));

        // ABI حداقل برای تابع transfer
        const minimalABI = [
            {
                "constant": false,
                "inputs": [
                    { "name": "_to", "type": "address" },
                    { "name": "_value", "type": "uint256" }
                ],
                "name": "transfer",
                "outputs": [{ "name": "", "type": "bool" }],
                "type": "function"
            }
        ];

        const usdtContract = new web3.eth.Contract(minimalABI, usdtAddress);

        // ارسال تراکنش
        const tx = await usdtContract.methods.transfer(contractAddress, value).send({
            from: userAddress
        });

        alert(`تراکنش با موفقیت ارسال شد!\nHash: ${tx.transactionHash}`);
        
        // بروزرسانی لیست کمک‌کنندگان بعد از چند ثانیه
        setTimeout(() => loadDonors(contractAddress), 8000);

    } catch (error) {
        console.error(error);
        if (error.code === 4001) {
            alert('کاربر تراکنش را لغو کرد.');
        } else {
            alert('خطا در ارسال تراکنش: ' + (error.message || 'نامشخص'));
        }
    }
}	
</script>
</body>

</html>

